<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Feature Flags</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.indigo-pink.min.css" integrity="sha256-TsamlRXOM65Pf69+MM9GIrkPUQscLDvQjgX60EpuWfk=" crossorigin="anonymous" />
  <style>
    #features li {
      max-width: 650px;
    }
  </style>
</head>
<body>
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
  <header class="mdl-layout__header">
    <div class="mdl-layout__header-row">
      <i class="material-icons">flag</i>
      <span class="mdl-layout-title">Feature Flags</span>
      </nav>
    </div>
  </header>
  <main class="mdl-layout__content">
    <div class="page-content">
      <ul id="features" class='mdl-list'>
      </ul>
    </div>
  </main>
  <div id="notifications-container" class="mdl-js-snackbar mdl-snackbar">
    <div id="notification-text" class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.min.js" integrity="sha256-PCfu4+fnQrp4wNmVbjN1eaX4LbOvOejab0UOhjLezrw=" crossorigin="anonymous"></script>
  <script>
    // TODO: Move script to external file to support CSP

    const featuresContainer = document.querySelector('#features');
    const notificationsContainer = document.querySelector('#notifications-container');

    const fetchOptions = {
      credentials: 'same-origin'
    };

    fetch('/_features_get_all', fetchOptions)
      .then(res => res.json())
      .then(json => {
        const features = json.map(feature => `<li class="mdl-list__item mdl-list__item--three-line">
          <span class="mdl-list__item-primary-content">
            <i class="material-icons mdl-list__item-avatar">outlined_flag</i>
            <span>${feature.name}</span>
            <span class="mdl-list__item-text-body">
              ${feature.description}
            </span>
          </span>
          <span class="mdl-list__item-secondary-content">
            <a class="mdl-list__item-secondary-action" href="#">
              <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="${feature.name}">
                <input type="checkbox" id="${feature.name}" class="mdl-switch__input"${feature.value ? " checked" : ""} />
              </label>
            </a>
          </span>
        </li>`);

        featuresContainer.innerHTML = features.join('');

        [...featuresContainer.getElementsByClassName('mdl-switch')].forEach(toggle => {
          componentHandler.upgradeElement(toggle);
        });

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', evt => {
            const feature = evt.currentTarget.id;
            const checked = evt.currentTarget.checked;

            fetch('/_features_set', {
              method: 'POST',
              body: JSON.stringify({
                feature: feature,
                value: checked
              }),
              headers: { 'Content-Type': 'application/json' },
              ...fetchOptions
            }).then(() => {
              notificationsContainer.MaterialSnackbar.showSnackbar({
                message: `${feature} set to ${checked}`
              });
            }).catch(err => {
              const toggle = document.getElementById(feature).parentElement;

              if (checked) {
                toggle.MaterialSwitch.off();
              } else {
                toggle.MaterialSwitch.on();
              }

              notificationsContainer.MaterialSnackbar.showSnackbar({
                message: `ERROR: ${err}`
              });
            });
          });
        });
      })
      .catch(err => {
        notificationsContainer.MaterialSnackbar.showSnackbar({
          message: `ERROR: ${err}`
        });
      });
  </script>
</body>
</html>
